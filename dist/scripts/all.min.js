angular.module("servicesModule",[]);
angular.module("servicesModule").factory("httpPaginationData",["$http","$q",function(i,a){function t(t,e,a){if(this.records=[],this.pageState=null,this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.dataMapping=function(t){return t},this.method="get","object"==typeof t&&1===arguments.length){var i=t;this.sourceUrl=i.sourceUrl,this.queryData=i.queryData,this.dataField=i.dataField||this.dataField,this.dataMapping=i.dataMapping||this.dataMapping,this.pageSize=i.pageSize,this.dataGotCallback=i.dataGotCallback}else this.sourceUrl=t,this.queryData=e,this.pageSize=e.pageSize,this.dataGotCallback=a.dataGotCallback;console.log("data got callback = ",this.dataGotCallback),console.log("typeof callback = ",typeof this.dataGotCallback)}function n(t,e){return t.pageIndex<t.records.length-1?function(t){return t.pageIndex++,a.resolve(t.records[t.pageIndex])}(t):function(e,t){var a=angular.extend({},e.queryData,{pageState:e.pageState,pageSize:e.pageSize},t);return"get"===e.method&&(a={params:a}),i[e.method](e.sourceUrl,a).then(function(t){return(t=t.data)[e.dataField]&&(e.pageIndex++,e.records.push(e.dataMapping(t[e.dataField]))),t.pageState!==e.pageState?e.pageState=t.pageState:e.pageState=null,t[e.dataField]})}(t,e)}function r(t,e){"function"==typeof t.dataGotCallback&&t.dataGotCallback(e)}return t.prototype.getNextPage=function(t){var e=this;return n(this,t).then(function(t){return r(e,t),t})},t.prototype.getPrevPage=function(){this.pageIndex--,r(this,this.records[this.pageIndex])},t.prototype.getPages=function(){return new Array(this.records.length)},t.prototype.gotoPage=function(t){this.pageIndex=t,r(this,this.records[this.pageIndex])},t}]).factory("paginationData",["service",function(a){function t(t,e){if(this.records=[],this.pageState=null,this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.dataMapping=function(t){return t},"object"==typeof t&&1===arguments.length){var a=t;this.sourceUrl=a.sourceUrl,this.queryData=a.queryData,this.dataField=a.dataField||this.dataField,this.dataMapping=a.dataMapping||this.dataMapping,this.pageSize=a.pageSize}else this.sourceUrl=t,this.queryData=e}return t.prototype.getNextPage=function(t){if(this.pageIndex<this.records.length-1)this.pageIndex++;else{var e=this;a.executePromiseAvoidDuplicate(this,"fetching",function(){return a.post(e.sourceUrl,angular.extend({},e.queryData,{pageState:e.pageState,pageSize:e.pageSize},t)).then(function(t){return t[e.dataField]&&(e.pageIndex++,e.records.push(e.dataMapping(t[e.dataField]))),e.pageState=t.pageState,t})})}},t.prototype.getPrevPage=function(){this.pageIndex--},t.prototype.getPages=function(){return new Array(this.records.length)},t}]).factory("paginationDataWithTotal",["service",function(a){function t(t,e){if(this.records=[],this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.totalField="total",this.dataMapping=function(t){return t},"object"==typeof t&&1===arguments.length){var a=t;this.sourceUrl=a.sourceUrl,this.queryData=a.queryData,this.dataField=a.dataField||this.dataField,this.dataMapping=a.dataMapping||this.dataMapping,this.pageSize=a.pageSize}else this.sourceUrl=t,this.queryData=e}return t.prototype.getNextPage=function(t){if(this.pageIndex<this.records.length-1)this.pageIndex++;else{var e=this;a.executePromiseAvoidDuplicate(this,"fetching",function(){return a.post(e.sourceUrl,angular.extend({},e.queryData,{offset:e.pageSize*(e.pageIndex+1),pageSize:e.pageSize},t)).then(function(t){t[e.dataField]&&(e.pageIndex++,e.records.push(e.dataMapping(t[e.dataField]))),t[e.totalField]&&(e.total=t[e.totalField])})})}},t.prototype.getPrevPage=function(){this.pageIndex--},t.prototype.getPages=function(){return new Array(this.records.length)},t.prototype.getTotalRecords=function(){for(var t=0,e=0;e<this.records.length;e++)t+=this.records[e].length;return t},t}]);
var url={parse:function(e){var r=document.createElement("a");return r.href=e,r}},scripts=document.getElementsByTagName("script"),path=scripts[scripts.length-1].src.split("?")[0],mydir=path.split("/").slice(0,-1).join("/")+"/",scriptLocation=url.parse(mydir);angular.module("servicesModule").factory("service",["$http","$q",function(n,o){var e={};for(var r in n)n.hasOwnProperty(r)&&"function"==typeof n[r]&&(e[r]=function(e){return function(){return r=n[e].apply(this,Array.prototype.slice.call(arguments)),t=o.defer(),r.then(function(e){if(!e)return t.reject("未收到服务器数据");(e=e.data).isSuccess?""===e.result||0===e.result||!1===e.result?t.resolve(e.result):t.resolve(e.result||e.results):(console.error(e),console.error(r.value),void 0!==e.code?(t.reject(e),"302"===String(e.code)&&(window.location.href=e.message)):t.reject(e.message||"服务器返回错误的数据"))},function(e){e=e?e.data:"未收到服务器数据",t.reject(e),e&&e.code&&"401"===String(e.code)&&"/sign-in"!==window.location.pathname&&(window.location.href="/sign-in?return_url="+encodeURIComponent(window.location.href))}),t.promise;var r,t}}(r));return e.executePromiseAvoidDuplicate=function(e,r,t){var n=o.defer();return e[r]?(n.reject("submitting..."),n):(e[r]=!0,t().finally(function(){e[r]=!1}))},e.postSync=function(e){var r=new Worker(mydir+"syncRequest.js");r.onmessage=function(e){console.log(e),alert(e.data)},r.postMessage("POST")},e}]);
self.onmessage=function(e){if("POST"===e.data){var s=new XMLHttpRequest;s.open("POST","./app.js",!1),s.send(null),self.postMessage(s.responseText)}};